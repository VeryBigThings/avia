name: "Run tests"
description: "Run CI tests"
inputs:
  ssh-private-key:
    description: "SSH private key used to fetch private deps"
    required: true

runs:
  using: "composite"
  steps:
    - run: echo ::set-env name=SSH_AUTH_SOCK::/tmp/ssh_agent.sock
      shell: bash

    - name: Setup SSH Keys and known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        ssh-agent -a $SSH_AUTH_SOCK > /dev/null
        ssh-add - <<< "${{ inputs.ssh-private-key }}"
      shell: bash

    - name: Fetch deps
      run: mix deps.get
      shell: bash

    - name: Compile project
      run: |
        MIX_ENV=test mix compile --warnings-as-errors
        MIX_ENV=dev mix compile --warnings-as-errors
        MIX_ENV=prod mix compile --warnings-as-errors
      shell: bash

    - name: Check code format
      run: mix format --check-formatted
      shell: bash

    - name: "Reset database"
      run: MIX_ENV=test mix cmd --app snitch_core mix ecto.reset
      shell: bash

    - name: Run tests
      run: make test
      shell: bash

    - name: Check migrations reversibility
      run: MIX_ENV=test mix ecto.rollback.all
      shell: bash

    - name: Check OTP release
      run: |
        mix release --overwrite

        DB_URL="postgresql://postgres:postgres@localhost/nue_test" _build/prod/rel/nue/bin/migrate_all.sh

        _build/prod/rel/nue/bin/nue eval "{:ok, _} = Application.ensure_all_started(:nue)"
        _build/prod/rel/nue/bin/migrate_all.sh
      shell: bash
