name: "Run tests"
description: "Run CI tests"
inputs:
  ssh-private-key:
    description: "SSH private key used to fetch private deps"
    required: true
env:
  AVIA_DOCS: https://www.aviacommerce.org/docs/getting-started.html
  ADMIN_PORT: 4000
  API_PORT: 3000
  AWS_ACCESS_KEY_ID: api_key
  AWS_REGION: aws_region
  AWS_SECRET_ACCESS_KEY: secret_api_key
  BACKEND_URL: http://localhost:4000
  BUCKET_NAME: bucket_name
  DB_URL: postgres://postgres:postgres:@db/snitch_dev
  ELASTIC_HOST: http://elasticsearch:9200/
  ETSY_CONSUMER_KEY: api_key
  ETSY_CONSUMER_SECRET: api_key
  FRONTEND_CHECKOUT_URL: http://localhost:4200/checkout/
  FRONTEND_URL: http://localhost:4200
  HOST: localhost
  HOSTED_PAYMENT_URL: http://localhost:3000/api/v1/hosted-payment/
  PASSWORD_RESET_SALT: password_reset_salt
  POOL_SIZE: 10
  SENDGRID_API_KEY: api_key
  SENDGRID_SENDER_EMAIL: noreplay@nue.com
  SESSION_COOKIE_NAME: nue_session
  SESSION_COOKIE_SIGNING_SALT: session_cookie_salt
  SESSION_COOKIE_ENCRYPTION_SALT: session_cookie_encryption
  SUPPORT_URL: https://admin.aviacommerce.org
  SECRET_KEY_BASE: oZiDNlntvnC+q7EAIKVUV/AYTJ30UQZh/eUwcFK5h7As0Rhc6Zuf//0fvx9pMZUY
  TEST_DB_URL: postgres://postgres:postgres:@db/snitch_test
  TOKEN_MAXIMUM_AGE: 36000
  WKHTML_PATH: /usr/local/bin/wkhtmltopdf
runs:
  using: "composite"
  steps:
    - run: echo ::set-env name=SSH_AUTH_SOCK::/tmp/ssh_agent.sock
      shell: bash

    - name: Setup SSH Keys and known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        ssh-agent -a $SSH_AUTH_SOCK > /dev/null
        ssh-add - <<< "${{ inputs.ssh-private-key }}"
      shell: bash

    - name: Fetch deps
      run: mix deps.get
      shell: bash

    - name: Compile project
      run: |
        MIX_ENV=test mix compile
        MIX_ENV=dev mix compile
      shell: bash

    - name: Check code format
      run: mix format --check-formatted
      shell: bash

    - name: "Reset database"
      run: MIX_ENV=test mix cmd --app snitch_core mix ecto.reset
      shell: bash

    - name: Run tests
      run: make test
      shell: bash

    - name: Check migrations reversibility
      run: MIX_ENV=test mix ecto.rollback.all
      shell: bash

    - name: Check OTP release
      run: mix release --overwrite
      shell: bash
